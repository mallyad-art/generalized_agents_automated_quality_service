<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generalized Agents: Automated Quality Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      margin: 24px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 14px;
    }

    th {
      background: #f5f5f5;
      text-align: left;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .toolbar-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pagination {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      align-items: center;
    }

    input[type="text"] {
      padding: 6px 8px;
      width: 320px;
    }

    button,
    select {
      padding: 6px 10px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .grouping-controls {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 12px;
    }

    .grouping-controls h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
    }

    .status-info {
      background: #e3f2fd;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .clear-grouping {
      background: #ff6b6b;
      color: white;
      border: none;
    }

    .clear-grouping:hover {
      background: #ff5252;
    }

    a {
      color: #1976d2;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .validation-info {
      font-size: 12px;
      margin-top: 4px;
      padding: 4px 8px;
      border-radius: 3px;
    }

    /* Search highlighting styles */
    mark {
      background-color: #ffeb3b !important;
      padding: 1px 2px !important;
      border-radius: 2px !important;
      font-weight: bold;
    }

    .search-info {
      background: #fff3e0;
      color: #f57c00;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 14px;
      border-left: 4px solid #ff9800;
    }

    .validation-success {
      background: #e8f5e8;
      color: #2e7d32;
    }

    .validation-error {
      background: #ffebee;
      color: #c62828;
    }

    .validation-warning {
      background: #fff3e0;
      color: #f57c00;
    }
  </style>
</head>

<body>
  <div class="container">
    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
      <img src="/static/logo.svg" alt="Logo" style="width: 60px; height: 60px;">
      <h1 style="margin: 0;">Generalized Agents: Automated Quality Dashboard</h1>
    </div>
    
    <!-- Sheet Selection -->
    {% if available_sheets|length > 1 %}
    <div class="sheet-selector" style="background: #e8f5e8; padding: 12px; border-radius: 4px; margin-bottom: 12px;">
      <h3 style="margin: 0 0 8px 0; font-size: 14px;">üìä Current Sheet: {{ current_sheet }}</h3>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        {% for sheet in available_sheets %}
          {% if sheet.name == current_sheet %}
            <span style="padding: 4px 8px; background: #4caf50; color: white; border-radius: 3px; font-size: 12px;">{{ sheet.display_name }}</span>
          {% else %}
            <a href="/?sheet={{ sheet.name }}&q={{ q }}&page_size={{ page_size }}" 
               style="padding: 4px 8px; background: #f5f5f5; color: #1976d2; border-radius: 3px; font-size: 12px; text-decoration: none;">{{ sheet.display_name }}</a>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Grouping Controls -->
    <div class="grouping-controls">
      <h3>Time-based Grouping (Optional)</h3>
      <form method="get" action="/">
        <input type="hidden" name="q" value="{{ q }}">
        <input type="hidden" name="page_size" value="{{ page_size }}">
        <input type="hidden" name="page" value="1">
        <input type="hidden" name="sheet" value="{{ current_sheet }}">

        <div class="toolbar-row">
          <select name="group_by_period">
            <option value="">No grouping</option>
            <option value="day" {% if group_by_period=="day" %}selected{% endif %}>Group by Day</option>
            <option value="week" {% if group_by_period=="week" %}selected{% endif %}>Group by Week</option>
          </select>

          <select name="timestamp_column">
            <option value="">Select timestamp column</option>
            {% for col in timestamp_columns %}
            <option value="{{ col }}" {% if timestamp_column==col %}selected{% endif %}>{{ col }}</option>
            {% endfor %}
          </select>

          <button type="submit" id="apply-grouping-btn">Apply</button>

          {% if grouped %}
          <a href="/?q={{ q }}&page_size={{ page_size }}&sheet={{ current_sheet }}" class="clear-grouping"
            style="padding: 6px 10px; border-radius: 4px;">Clear Grouping</a>
          {% endif %}
        </div>
        <div id="validation-info" class="validation-info" style="display: none;"></div>
      </form>
    </div>

    <!-- Search and Pagination Controls -->
    <form class="toolbar" method="get" action="/">
      <input type="hidden" name="group_by_period" value="{{ group_by_period }}">
      <input type="hidden" name="timestamp_column" value="{{ timestamp_column }}">
      <input type="hidden" name="page" value="1">
      <input type="hidden" name="sheet" value="{{ current_sheet }}">

      <input name="q" type="text" placeholder="Search and highlight terms‚Ä¶" value="{{ q }}">
      <select name="page_size">
        {% for size in [10,25,50,100] %}
        <option value="{{size}}" {% if size==page_size %}selected{% endif %}>{{size}} / page</option>
        {% endfor %}
      </select>
      <button type="submit">Search</button>
    </form>

    <!-- Status Information -->
    {% if error_message %}
    <div class="status-info" style="background: #ffebee; color: #c62828; border-left: 4px solid #f44336;">
      ‚ùå Grouping Error: {{ error_message }}
    </div>
    {% elif grouped %}
    <div class="status-info">
      üìä Data grouped by {{ group_by_period }} using column "{{ timestamp_column }}"
    </div>
    {% endif %}

    <!-- Search Information -->
    {% if q and q.strip() %}
    <div class="search-info">
      üîç Searching for "<strong>{{ q }}</strong>" - matching terms are <mark>highlighted</mark> in results
    </div>
    {% endif %}

    <div>{{ total }} rows{% if grouped %} (grouped){% endif %}{% if q and q.strip() %} matching "{{ q }}"{% endif %}</div>

    <table>
      <thead>
        <tr>
          {% for c in cols %}
          <th>{{ c }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          {% for c in cols %}
          <td>{{ r[c]|safe }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination">
      <form method="get" action="/">
        <input type="hidden" name="q" value="{{ q }}">
        <input type="hidden" name="page_size" value="{{ page_size }}">
        <input type="hidden" name="group_by_period" value="{{ group_by_period }}">
        <input type="hidden" name="timestamp_column" value="{{ timestamp_column }}">
        <input type="hidden" name="sheet" value="{{ current_sheet }}">
        <button name="page" value="{{ 1 }}" {% if page==1 %}disabled{% endif %}>&laquo; First</button>
        <button name="page" value="{{ page - 1 }}" {% if page <=1 %}disabled{% endif %}>Prev</button>
        <span>Page {{ page }} of {{ pages }}</span>
        <button name="page" value="{{ page + 1 }}" {% if page>= pages %}disabled{% endif %}>Next</button>
        <button name="page" value="{{ pages }}" {% if page>= pages %}disabled{% endif %}>Last &raquo;</button>
      </form>
    </div>
  </div>

  <script>
    // Client-side validation for timestamp columns
    document.addEventListener('DOMContentLoaded', function () {
      const timestampSelect = document.querySelector('select[name="timestamp_column"]');
      const periodSelect = document.querySelector('select[name="group_by_period"]');
      const validationInfo = document.getElementById('validation-info');
      const applyBtn = document.getElementById('apply-grouping-btn');

      function validateTimestampColumn() {
        const column = timestampSelect.value;
        const period = periodSelect.value;

        if (!column || !period) {
          validationInfo.style.display = 'none';
          return;
        }

        // Show loading state
        validationInfo.className = 'validation-info validation-warning';
        validationInfo.textContent = 'Validating timestamp column...';
        validationInfo.style.display = 'block';

        // Validate the column
        const currentSheet = document.querySelector('input[name="sheet"]')?.value || '';
        fetch(`/api/validate-timestamp?column=${encodeURIComponent(column)}&sheet=${encodeURIComponent(currentSheet)}`)
          .then(response => response.json())
          .then(data => {
            if (data.valid) {
              validationInfo.className = 'validation-info validation-success';
              validationInfo.textContent = `‚úì ${data.message}`;
            } else {
              validationInfo.className = 'validation-info validation-error';
              validationInfo.textContent = `‚úó ${data.message}`;
            }
          })
          .catch(error => {
            validationInfo.className = 'validation-info validation-error';
            validationInfo.textContent = 'Error validating column';
          });
      }

      // Validate when timestamp column or period changes
      timestampSelect.addEventListener('change', validateTimestampColumn);
      periodSelect.addEventListener('change', validateTimestampColumn);

      // Initial validation if values are already selected
      if (timestampSelect.value && periodSelect.value) {
        validateTimestampColumn();
      }
    });
  </script>
</body>

</html>